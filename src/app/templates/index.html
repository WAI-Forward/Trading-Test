<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trading Test · Dashboard</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.5;
      }

      body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at top, #0f172a, #020617);
        color: #f8fafc;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      main {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 18px;
        padding: 2.5rem 3rem;
        width: min(820px, 92vw);
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.5);
        backdrop-filter: blur(12px);
      }

      h1 {
        margin-top: 0;
        font-size: clamp(1.75rem, 3vw, 2.5rem);
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #38bdf8;
      }

      p.subtitle {
        margin-top: 0.3rem;
        margin-bottom: 2.2rem;
        color: rgba(226, 232, 240, 0.8);
        font-size: 1rem;
      }

      .actions {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 2rem;
      }

      button.primary {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.8rem;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        color: #0f172a;
        background: linear-gradient(135deg, #38bdf8, #22d3ee);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(34, 211, 238, 0.35);
      }

      button.primary:active {
        transform: translateY(0);
      }

      .ticker-form {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        min-width: clamp(240px, 40vw, 360px);
      }

      .ticker-label {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.8);
      }

      .ticker-controls {
        display: flex;
        gap: 0.75rem;
      }

      .ticker-input {
        flex: 1 1 auto;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.75);
        color: inherit;
        padding: 0.75rem 1.1rem;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .ticker-input:focus {
        border-color: rgba(56, 189, 248, 0.8);
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
      }

      section.status-panel {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 1.5rem;
        display: grid;
        gap: 1rem;
      }

      .status-row {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .status-label {
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.75);
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        font-size: 1rem;
        font-weight: 600;
        padding: 0.55rem 1rem;
        border-radius: 999px;
        transition: background-color 0.2s ease, color 0.2s ease;
      }

      .status-indicator::before {
        content: "";
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        background-color: currentColor;
      }

      .status-valid {
        color: #4ade80;
        background-color: rgba(74, 222, 128, 0.15);
      }

      .status-expiring-soon {
        color: #facc15;
        background-color: rgba(250, 204, 21, 0.15);
      }

      .status-invalid {
        color: #f87171;
        background-color: rgba(248, 113, 113, 0.15);
      }

      .status-detail {
        font-size: 0.9rem;
        color: rgba(226, 232, 240, 0.8);
      }

      .flash-message {
        margin: 0 0 1.5rem 0;
        padding: 0.85rem 1.2rem;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 500;
        background-color: rgba(59, 130, 246, 0.15);
        color: #bfdbfe;
        border: 1px solid rgba(59, 130, 246, 0.35);
      }

      .flash-message.flash-error {
        background-color: rgba(248, 113, 113, 0.18);
        border-color: rgba(248, 113, 113, 0.35);
        color: #fecaca;
      }

      .flash-message.flash-success {
        background-color: rgba(74, 222, 128, 0.18);
        border-color: rgba(74, 222, 128, 0.35);
        color: #bbf7d0;
      }

      .ohlc-panel {
        margin-top: 2.5rem;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .ohlc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .ohlc-header h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.85);
      }

      .stream-status {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 6.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .stream-status-idle {
        background: rgba(148, 163, 184, 0.15);
        color: rgba(148, 163, 184, 0.85);
      }

      .stream-status-connecting {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
      }

      .stream-status-active {
        background: rgba(34, 197, 94, 0.18);
        color: #4ade80;
      }

      .stream-status-complete {
        background: rgba(45, 212, 191, 0.18);
        color: #5eead4;
      }

      .stream-status-error {
        background: rgba(248, 113, 113, 0.18);
        color: #fca5a5;
      }

      .stream-meta {
        margin: 0;
        font-size: 0.95rem;
        color: rgba(226, 232, 240, 0.85);
      }

      .table-wrapper {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        overflow: hidden;
      }

      .ohlc-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        background: rgba(15, 23, 42, 0.75);
      }

      .ohlc-table th,
      .ohlc-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      }

      .ohlc-table tbody tr:last-child td {
        border-bottom: none;
      }

      .ohlc-table tbody tr:nth-child(odd) {
        background: rgba(30, 41, 59, 0.55);
      }

      .help-text {
        margin-top: 1.8rem;
        font-size: 0.85rem;
        color: rgba(148, 163, 184, 0.75);
      }

      code {
        background: rgba(15, 23, 42, 0.7);
        padding: 0.25rem 0.45rem;
        border-radius: 6px;
      }

      @media (max-width: 640px) {
        main {
          padding: 2rem 1.6rem;
        }

        .actions {
          flex-direction: column;
          align-items: stretch;
        }

        .ticker-form {
          width: 100%;
        }

        .ticker-controls {
          flex-direction: column;
        }

        .ticker-controls button {
          width: 100%;
        }

        section.status-panel {
          padding: 1.25rem;
        }

        .ohlc-panel {
          padding: 1.25rem;
        }

        .ohlc-table th,
        .ohlc-table td {
          padding: 0.65rem 0.75rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Trading Test Control Centre</h1>
      <p class="subtitle">
        Launch the cTrader OAuth flow and monitor whether an access token is available on this device.
      </p>

      <div class="actions">
        <button type="button" class="primary" id="loginButton">Sign in with cTrader</button>
        <form class="ticker-form" id="tickerForm" autocomplete="off">
          <label class="ticker-label" for="tickerInput">Stream OHLC</label>
          <div class="ticker-controls">
            <input
              id="tickerInput"
              class="ticker-input"
              name="ticker"
              type="text"
              spellcheck="false"
              placeholder="Enter ticker (e.g. EURUSD)"
              aria-label="Ticker symbol"
              required
            />
            <button type="submit" class="primary" id="streamButton">Go</button>
          </div>
        </form>
      </div>

      <p id="flashMessage" class="flash-message" role="status" hidden></p>

      <section class="status-panel" aria-live="polite">
        <div class="status-row">
          <span class="status-label">Access Token</span>
          <span id="tokenStatus" class="status-indicator status-invalid">Token missing</span>
          <span id="tokenDetail" class="status-detail">No access token found in local storage.</span>
        </div>
        <div class="status-row">
          <span class="status-label">Expiry</span>
          <span id="expiryStatus" class="status-indicator status-invalid">Unknown</span>
          <span id="expiryDetail" class="status-detail">Token expiry could not be determined.</span>
        </div>
      </section>

      <section class="ohlc-panel" aria-live="polite" aria-busy="false">
        <div class="ohlc-header">
          <h2>OHLC Stream</h2>
          <span id="streamStatus" class="stream-status stream-status-idle">Idle</span>
        </div>
        <p id="streamMeta" class="stream-meta">
          Provide a ticker symbol and click <strong>Go</strong> to stream the latest OHLC candles from cTrader.
        </p>
        <div class="table-wrapper">
          <table class="ohlc-table" aria-live="polite">
            <thead>
              <tr>
                <th scope="col">Timestamp</th>
                <th scope="col">Open</th>
                <th scope="col">High</th>
                <th scope="col">Low</th>
                <th scope="col">Close</th>
                <th scope="col">Volume</th>
              </tr>
            </thead>
            <tbody id="ohlcTableBody"></tbody>
          </table>
        </div>
      </section>

      <p class="help-text">
        The indicators above read from <code>localStorage</code> keys named <code>ctrader_access_token</code> and
        <code>ctrader_access_token_expires_at</code>. Update those values after completing the OAuth flow to reflect the latest
        access token status. The OHLC streamer also expects a <code>ctrader_account_id</code> key containing your numeric
        <code>ctidTraderAccountId</code>. Optionally, you can adjust the <code>ctrader_ohlc_timeframe</code> and
        <code>ctrader_ohlc_limit</code> keys to customise requests.
      </p>
    </main>

    <script>
      (function () {
        const LOGIN_ENDPOINT = "/login";
        const TOKEN_STORAGE_KEY = "ctrader_access_token";
        const EXPIRY_STORAGE_KEY = "ctrader_access_token_expires_at";

        const loginButton = document.querySelector("#loginButton");
        const tickerForm = document.querySelector("#tickerForm");
        const tickerInput = document.querySelector("#tickerInput");
        const streamStatus = document.querySelector("#streamStatus");
        const streamMeta = document.querySelector("#streamMeta");
        const ohlcTableBody = document.querySelector("#ohlcTableBody");
        const tokenStatus = document.querySelector("#tokenStatus");
        const tokenDetail = document.querySelector("#tokenDetail");
        const expiryStatus = document.querySelector("#expiryStatus");
        const expiryDetail = document.querySelector("#expiryDetail");
        const flashMessage = document.querySelector("#flashMessage");
        let activeStream;

        function showFlash(message, tone = "info") {
          if (!flashMessage) {
            return;
          }

          flashMessage.classList.remove("flash-error", "flash-success");

          if (message) {
            if (tone === "error") {
              flashMessage.classList.add("flash-error");
            } else if (tone === "success") {
              flashMessage.classList.add("flash-success");
            }

            flashMessage.textContent = message;
            flashMessage.hidden = false;
          } else {
            flashMessage.hidden = true;
          }
        }

        function setStatus(element, detailElement, state, summary, detail) {
          element.classList.remove("status-valid", "status-invalid", "status-expiring-soon");
          element.classList.add(state);
          element.textContent = summary;
          detailElement.textContent = detail;
        }

        function describeExpiry(dateValue) {
          const now = new Date();
          if (!(dateValue instanceof Date) || Number.isNaN(dateValue.valueOf())) {
            return { state: "status-invalid", summary: "Unknown", detail: "Token expiry could not be determined." };
          }

          const diffMs = dateValue - now;

          if (diffMs <= 0) {
            const formatter = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });
            const minutes = Math.round(diffMs / 60000);
            return {
              state: "status-invalid",
              summary: "Expired",
              detail: `Token expired ${formatter.format(minutes, "minute")}.`,
            };
          }

          const hoursRemaining = diffMs / 3600000;
          const formatter = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });

          if (hoursRemaining <= 1) {
            return {
              state: "status-expiring-soon",
              summary: "Expiring soon",
              detail: `Token will expire ${formatter.format(Math.round(diffMs / 60000), "minute")}.`,
            };
          }

          return {
            state: "status-valid",
            summary: "Active",
            detail: `Token valid until ${dateValue.toLocaleString()}.`,
          };
        }

        function updateStreamStatus(state, summary) {
          if (!streamStatus) {
            return;
          }

          const statusClasses = [
            "stream-status-idle",
            "stream-status-connecting",
            "stream-status-active",
            "stream-status-complete",
            "stream-status-error",
          ];

          streamStatus.classList.remove(...statusClasses);
          streamStatus.classList.add(state);
          streamStatus.textContent = summary;
        }

        function resetStreamTable() {
          if (ohlcTableBody) {
            ohlcTableBody.innerHTML = "";
          }
        }

        function appendStreamRow(bar) {
          if (!ohlcTableBody) {
            return;
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${bar.timestamp ?? ""}</td>
            <td>${formatNumber(bar.open)}</td>
            <td>${formatNumber(bar.high)}</td>
            <td>${formatNumber(bar.low)}</td>
            <td>${formatNumber(bar.close)}</td>
            <td>${bar.volume != null ? formatNumber(bar.volume) : "—"}</td>
          `;

          if (ohlcTableBody.firstChild) {
            ohlcTableBody.insertBefore(row, ohlcTableBody.firstChild);
          } else {
            ohlcTableBody.appendChild(row);
          }
        }

        function formatNumber(value) {
          if (typeof value !== "number" || Number.isNaN(value)) {
            return "—";
          }

          return new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 5,
          }).format(value);
        }

        function parseEventData(event) {
          try {
            return JSON.parse(event.data);
          } catch (error) {
            console.error("Unable to parse event data", error);
            return null;
          }
        }

        function closeActiveStream(nextState) {
          if (activeStream) {
            activeStream.close();
            activeStream = undefined;
          }

          if (!nextState) {
            return;
          }

          if (nextState === "idle") {
            updateStreamStatus("stream-status-idle", "Idle");
          } else if (nextState === "error") {
            updateStreamStatus("stream-status-error", "Error");
          }
        }

        function startStream(ticker) {
          const trimmedTicker = ticker.trim().toUpperCase();

          if (!trimmedTicker) {
            showFlash("Please provide a ticker symbol before streaming.", "error");
            tickerInput?.focus();
            return;
          }

          const accessToken = localStorage.getItem(TOKEN_STORAGE_KEY)?.trim();
          if (!accessToken) {
            showFlash("No access token found. Sign in with cTrader first.", "error");
            return;
          }

          const accountId = localStorage.getItem("ctrader_account_id")?.trim();
          if (!accountId) {
            showFlash(
              "Missing 'ctrader_account_id' in localStorage. Set it to your cTrader account id.",
              "error",
            );
            return;
          }

          const timeframe = localStorage.getItem("ctrader_ohlc_timeframe")?.trim() || "M1";
          const limit = localStorage.getItem("ctrader_ohlc_limit")?.trim() || "100";

          const params = new URLSearchParams({
            access_token: accessToken,
            account_id: accountId,
            timeframe,
            limit,
          });

          const url = `/ohlc-stream/${encodeURIComponent(trimmedTicker)}?${params.toString()}`;

          closeActiveStream("idle");
          resetStreamTable();

          updateStreamStatus("stream-status-connecting", "Connecting…");
          showFlash(null);
          if (streamMeta) {
            streamMeta.textContent = `Requesting ${timeframe} candles for ${trimmedTicker}…`;
          }

          const eventSource = new EventSource(url);
          activeStream = eventSource;

          eventSource.addEventListener("meta", (event) => {
            const data = parseEventData(event);
            if (!data) {
              return;
            }

            resetStreamTable();
            updateStreamStatus("stream-status-active", "Streaming");
            if (streamMeta) {
              streamMeta.textContent = `Streaming ${data.count} candle(s) for ${data.ticker} (${data.timeframe}).`;
            }
          });

          eventSource.addEventListener("bar", (event) => {
            const data = parseEventData(event);
            if (!data) {
              return;
            }

            appendStreamRow(data);
          });

          eventSource.addEventListener("complete", (event) => {
            const data = parseEventData(event);
            updateStreamStatus("stream-status-complete", "Complete");

            if (data && streamMeta) {
              streamMeta.textContent = `Received ${data.count} candle(s) for ${data.ticker}.`;
            }

            showFlash("OHLC stream completed successfully.", "success");
            closeActiveStream();
          });

          eventSource.addEventListener("error", (event) => {
            const data = parseEventData(event);
            if (data?.message) {
              showFlash(data.message, "error");
            } else {
              showFlash("Stream closed due to an unexpected error.", "error");
            }

            if (streamMeta) {
              streamMeta.textContent = "Unable to stream OHLC data. Adjust the inputs and try again.";
            }

            closeActiveStream("error");
          });

          eventSource.onerror = () => {
            showFlash("Lost connection to OHLC stream.", "error");
            if (streamMeta) {
              streamMeta.textContent = "The stream disconnected. Please try again.";
            }

            closeActiveStream("error");
          };
        }

        function refreshIndicators() {
          const storedToken = localStorage.getItem(TOKEN_STORAGE_KEY);
          const trimmedToken = storedToken ? storedToken.trim() : "";

          if (trimmedToken) {
            setStatus(
              tokenStatus,
              tokenDetail,
              "status-valid",
              "Token stored",
              `Access token present (${trimmedToken.length} characters).`
            );
          } else {
            setStatus(
              tokenStatus,
              tokenDetail,
              "status-invalid",
              "Token missing",
              "No access token found in local storage."
            );
          }

          const expiryRaw = localStorage.getItem(EXPIRY_STORAGE_KEY);
          if (expiryRaw) {
            const parsed = new Date(expiryRaw);
            const { state, summary, detail } = describeExpiry(parsed);
            setStatus(expiryStatus, expiryDetail, state, summary, detail);
          } else {
            setStatus(
              expiryStatus,
              expiryDetail,
              "status-invalid",
              "Unknown",
              "Token expiry could not be determined."
            );
          }
        }

        const currentUrl = new URL(window.location.href);
        const params = currentUrl.searchParams;
        let updatedFromRedirect = false;

        if (params.has(TOKEN_STORAGE_KEY)) {
          const incomingToken = params.get(TOKEN_STORAGE_KEY) ?? "";

          if (incomingToken) {
            localStorage.setItem(TOKEN_STORAGE_KEY, incomingToken);
          } else {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
          }

          updatedFromRedirect = true;
        }

        if (params.has(EXPIRY_STORAGE_KEY)) {
          const incomingExpiry = params.get(EXPIRY_STORAGE_KEY) ?? "";

          if (incomingExpiry) {
            localStorage.setItem(EXPIRY_STORAGE_KEY, incomingExpiry);
          } else {
            localStorage.removeItem(EXPIRY_STORAGE_KEY);
          }

          updatedFromRedirect = true;
        }

        const errorMessage = params.get("error");

        if (errorMessage) {
          showFlash(errorMessage, "error");
        } else if (updatedFromRedirect) {
          showFlash("Access token stored for this browser.", "success");
        } else {
          showFlash(null);
        }

        if ([TOKEN_STORAGE_KEY, EXPIRY_STORAGE_KEY, "error", "state"].some((key) => params.has(key))) {
          currentUrl.search = "";
          window.history.replaceState({}, document.title, currentUrl.toString());
        }

        loginButton?.addEventListener("click", () => {
          window.location.assign(LOGIN_ENDPOINT);
        });

        tickerForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          const value = tickerInput?.value ?? "";
          startStream(value);
        });

        window.addEventListener("storage", (event) => {
          if (event.key === TOKEN_STORAGE_KEY || event.key === EXPIRY_STORAGE_KEY || event.key === null) {
            refreshIndicators();
          }
        });

        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            refreshIndicators();
          }
        });

        window.addEventListener("beforeunload", () => {
          closeActiveStream("idle");
        });

        refreshIndicators();
      })();
    </script>
  </body>
</html>
